<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yunikorn Scheduler Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            color: #374151;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 24px 30px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #000000;
        }
        .header h1 {
            color: #374151;
            font-size: 24px;
            font-weight: 600;
        }
        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-box input {
            padding: 10px 16px;
            border: 1px solid #000000;
            border-radius: 6px;
            background: #ffffff;
            color: #374151;
            font-size: 14px;
            width: 280px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-box input:focus {
            border-color: #000000;
            box-shadow: 0 0 0 3px rgba(156,163,175,0.1);
        }
        .search-box button {
            padding: 10px 20px;
            background: #ffffff;
            color: #374151;
            border: 1px solid #000000;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }
        .search-box button:hover {
            background: #ffffff;
            border-color: #000000;
        }
        .refresh-btn, .search-btn {
            padding: 10px 16px;
            background: #ffffff;
            color: #374151;
            border: 1px solid #000000;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .refresh-btn:hover, .search-btn:hover {
            background: #ffffff;
            border-color: #000000;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .card {
            background: #ffffff;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #000000;
        }
        .card-full {
            grid-column: 1 / -1;
        }
        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #111827;
            border-bottom: 2px solid #000000;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #000000;
            border-radius: 2px;
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        .metric {
            background: #ffffff;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #000000;
        }
        .metric-label {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #374151;
        }
        .metric-unit {
            font-size: 11px;
            color: #ffffff;
            font-weight: 400;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 2px solid #000000;
            background: #ffffff;
            font-weight: 600;
            color: #374151;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #000000;
            color: #4b5563;
        }
        tr:hover td {
            background: #ffffff;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #ffffff;
            color: #374151;
            border: 1px solid #000000;
        }
        .placeholder-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            background: #ffffff;
            color: #374151;
            border: 1px solid #000000;
        }
        .app-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .app-id {
            font-size: 18px;
            font-weight: 700;
            color: #374151;
        }
        .app-meta {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #6b7280;
        }
        .app-meta strong {
            color: #374151;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .error {
            background: #ffffff;
            color: #374151;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #000000;
        }
        .log-entry {
            padding: 10px 12px;
            background: #ffffff;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 11px;
            border-left: 3px solid #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-entry.warning {
            border-left-color: #000000;
            background: #ffffff;
        }
        .log-entry.error {
            border-left-color: #000000;
            background: #ffffff;
        }
        .log-message {
            flex: 1;
            margin-right: 12px;
            word-break: break-word;
        }
        .log-count {
            background: #ffffff;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 10px;
            color: #6b7280;
        }
        #appsList {
            max-height: 500px;
            overflow-y: auto;
        }
        #appsList::-webkit-scrollbar {
            width: 8px;
        }
        #appsList::-webkit-scrollbar-track {
            background: #ffffff;
            border-radius: 4px;
        }
        #appsList::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 4px;
        }
        #appsList::-webkit-scrollbar-thumb:hover {
            background: #e5e7eb;
        }
        code {
            background: #ffffff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            color: #6b7280;
            font-family: 'Courier New', monospace;
        }
        .back-btn {
            padding: 8px 16px;
            background: #ffffff;
            color: #374151;
            border: 1px solid #000000;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 20px;
            display: inline-block;
            transition: all 0.2s;
        }
        .back-btn:hover {
            background: #ffffff;
            border-color: #000000;
        }
        .info-pill {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            margin: 2px;
            background: #ffffff;
            color: #374151;
            border: 1px solid #000000;
        }
        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #000000;
            border-radius: 6px;
        }
        .table-wrapper::-webkit-scrollbar {
            width: 6px;
        }
        .table-wrapper::-webkit-scrollbar-track {
            background: #ffffff;
        }
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 3px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #ffffff;
            border-radius: 4px;
            border: 1px solid #000000;
            font-size: 11px;
        }
        .info-item label {
            color: #6b7280;
            font-weight: 500;
        }
        .info-item value {
            color: #111827;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Yunikorn Scheduler Dashboard</h1>
            <div class="search-box">
                <input type="text" id="appIdInput" placeholder="Enter App ID (e.g., test-00030)">
                <button onclick="searchApp()">Search</button>
                <button class="refresh-btn" onclick="loadApps()">Refresh</button>
            </div>
        </div>

        <!-- Queue Explorer Section -->
        <div class="card card-full" id="queueExplorerCard">
            <div class="card-title">Queue Explorer</div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 16px;">
                <input type="text" id="partitionNameInput" placeholder="Partition Name (e.g., default)" value="default" style="padding: 10px 16px; border: 1px solid #000000; border-radius: 6px; font-size: 14px; width: 200px;">
                <input type="text" id="queueNameInput" placeholder="Queue Name (e.g., root.default)" style="padding: 10px 16px; border: 1px solid #000000; border-radius: 6px; font-size: 14px; width: 250px;">
                <button onclick="loadQueueInfo()" class="search-btn">Load Queue Info</button>
                <button onclick="loadQueueApplications()" class="search-btn">Load Queue Apps</button>
                <button class="refresh-btn" onclick="clearQueueExplorer()">Clear</button>
            </div>

            <!-- Queue Info Display -->
            <div id="queueInfoContainer" style="display: none;">
                <div class="card-title" style="font-size: 13px; margin-top: 20px;">Queue Information</div>
                <div class="info-grid" id="queueInfoGrid"></div>
            </div>

            <!-- Queue Applications Display -->
            <div id="queueAppsContainer" style="display: none;">
                <div class="card-title" style="font-size: 13px; margin-top: 20px;">Queue Applications</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Application ID</th>
                                <th>Queue</th>
                                <th>State</th>
                                <th>Used Resources</th>
                                <th>Pending Resources</th>
                                <th>Allocations</th>
                                <th>Submission Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="queueAppsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Apps List Card -->
        <div class="card card-full" id="appsListCard">
            <div class="card-title">Active Applications</div>
            <div id="appsList">
                <div class="loading">Loading applications...</div>
            </div>
        </div>

        <!-- Application Detail Dashboard -->
        <div id="appDashboard" style="display: none;">
            <button class="back-btn" onclick="backToList()">‚Üê Back to Applications</button>

            <!-- App Header -->
            <div class="card card-full">
                <div class="app-info">
                    <div>
                        <span class="app-id" id="appId">test-00030</span>
                        <span id="appState" class="status-badge status-running">Running</span>
                        <span id="placeholderStatus"></span>
                    </div>
                    <div class="app-meta">
                        <span>Queue: <strong id="appQueue">root.default</strong></span>
                        <span>Submitted: <strong id="appSubmissionTime">2 minutes ago</strong></span>
                        <span id="reservationStatus"></span>
                    </div>
                </div>
            </div>

            <!-- Application Info -->
            <div class="card card-full">
                <div class="card-title">Application Information</div>
                <div class="info-grid" id="appInfoGrid">
                </div>
            </div>

            <!-- Allocated Resources -->
            <div class="card">
                <div class="card-title">Allocated Resources</div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-label">Memory</div>
                        <div class="metric-value" id="usedMemory">0</div>
                        <div class="metric-unit">GB</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">vCore</div>
                        <div class="metric-value" id="usedVcore">0</div>
                        <div class="metric-unit">cores</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Pods</div>
                        <div class="metric-value" id="usedPods">0</div>
                        <div class="metric-unit">pods</div>
                    </div>
                </div>
            </div>

            <!-- Pending Resources -->
            <div class="card">
                <div class="card-title">Pending Resources</div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-label">Memory</div>
                        <div class="metric-value" id="pendingMemory">0</div>
                        <div class="metric-unit">GB</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">vCore</div>
                        <div class="metric-value" id="pendingVcore">0</div>
                        <div class="metric-unit">cores</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Pods</div>
                        <div class="metric-value" id="pendingPods">0</div>
                        <div class="metric-unit">pods</div>
                    </div>
                </div>
            </div>

            <!-- Allocation Summary -->
            <div class="card">
                <div class="card-title">Allocation Summary</div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-label">Total Allocations</div>
                        <div class="metric-value" id="totalAllocations">0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Pending Requests</div>
                        <div class="metric-value" id="pendingRequestsCount">0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Placeholders</div>
                        <div class="metric-value" id="placeholderCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Allocations Table -->
            <div class="card card-full">
                <div class="card-title">Current Allocations</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Allocation Key</th>
                                <th>Pod Name</th>
                                <th>Node</th>
                                <th>Memory</th>
                                <th>vCore</th>
                                <th>Pods</th>
                                <th>Task Group</th>
                                <th>Placeholder</th>
                                <th>Request Time</th>
                                <th>Allocation Time</th>
                                <th>Delay</th>
                            </tr>
                        </thead>
                        <tbody id="allocationsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pending Requests Table -->
            <div class="card card-full">
                <div class="card-title">Pending Requests</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Allocation Key</th>
                                <th>Pod Name</th>
                                <th>Memory</th>
                                <th>vCore</th>
                                <th>Pods</th>
                                <th>Task Group</th>
                                <th>Priority</th>
                                <th>Scheduled</th>
                                <th>Placeholder</th>
                                <th>Triggered Scale Up</th>
                                <th>Logs Count</th>
                            </tr>
                        </thead>
                        <tbody id="pendingRequestsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Allocation Logs -->
            <div class="card card-full">
                <div class="card-title">Scheduling Events</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Event Message</th>
                                <th>Count</th>
                                <th>Last Occurrence</th>
                            </tr>
                        </thead>
                        <tbody id="allocationLogsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gang Scheduling Status -->
            <div class="card card-full">
                <div class="card-title">Gang Scheduling Status</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Task Group</th>
                                <th>Min Memory</th>
                                <th>Min vCore</th>
                                <th>Min Pods</th>
                                <th>Required Count</th>
                                <th>Allocated</th>
                                <th>Replaced</th>
                                <th>Timed Out</th>
                            </tr>
                        </thead>
                        <tbody id="gangSchedulingBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Placeholder Details -->
            <div class="card card-full">
                <div class="card-title">Placeholder Details</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Task Group</th>
                                <th>Required Count</th>
                                <th>Current Allocations</th>
                                <th>Min Memory</th>
                                <th>Min vCore</th>
                                <th>Min Pods</th>
                                <th>Replaced</th>
                                <th>Timed Out</th>
                            </tr>
                        </thead>
                        <tbody id="placeholderDetailsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Allocation Tags -->
            <div class="card card-full">
                <div class="card-title">Allocation Tags (All)</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Allocation Key</th>
                                <th>Pod Name</th>
                                <th>Namespace</th>
                                <th>Application ID</th>
                                <th>Queue</th>
                                <th>Labels</th>
                            </tr>
                        </thead>
                        <tbody id="allocationTagsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const YUNIKORN_API = '/api/ws/v1';

        // Load active applications
        async function loadApps() {
            console.log('Loading applications from:', YUNIKORN_API + '/partition/default/applications/active');
            try {
                const response = await fetch(YUNIKORN_API + '/partition/default/applications/active');
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const apps = await response.json();
                console.log('Applications loaded:', apps);
                displayApps(apps);
            } catch (error) {
                console.error('Failed to load applications:', error);
                document.getElementById('appsList').innerHTML =
                    `<div class="error">Failed to load applications: ${error.message}<br>Make sure the proxy server is running on port 8083</div>`;
            }
        }

        // Display applications list
        function displayApps(apps) {
            const container = document.getElementById('appsList');
            if (!apps || apps.length === 0) {
                container.innerHTML = '<div class="loading">No active applications found</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Application ID</th>
                            <th>Queue</th>
                            <th>State</th>
                            <th>Used Resources</th>
                            <th>Pending Resources</th>
                            <th>Allocations</th>
                            <th>Submission Time</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            apps.forEach(app => {
                const stateClass = getStateClass(app.applicationState);
                const used = formatResourceCompact(app.usedResource);
                const pending = formatResourceCompact(app.pendingResource);
                const allocCount = app.allocations ? app.allocations.length : 0;
                const submissionTime = formatTimestamp(app.submissionTime);

                html += `
                    <tr>
                        <td><strong>${app.applicationID || 'N/A'}</strong></td>
                        <td>${app.queueName || 'N/A'}</td>
                        <td><span class="status-badge ${stateClass}">${app.applicationState || 'Unknown'}</span></td>
                        <td>${used}</td>
                        <td>${pending}</td>
                        <td>${allocCount}</td>
                        <td>${submissionTime}</td>
                        <td><button class="refresh-btn" onclick='searchAppById("${app.applicationID}")'>View</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Search app by ID
        async function searchApp() {
            const appId = document.getElementById('appIdInput').value.trim();
            if (!appId) {
                alert('Please enter an Application ID');
                return;
            }
            await searchAppById(appId);
        }

        async function searchAppById(appId) {
            console.log('Loading application:', appId);
            try {
                const response = await fetch(`${YUNIKORN_API}/partition/default/application/${appId}`);
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const app = await response.json();
                console.log('Application data:', app);

                if (!app.applicationID) {
                    throw new Error('Application not found. It may have already completed or does not exist in Yunikorn.');
                }

                displayAppDetails(app);
            } catch (error) {
                console.error('Failed to load application:', error);
                alert(`Failed to load application: ${error.message}\n\nTip: Only running applications can be viewed. Completed apps are not accessible via the API.`);
            }
        }

        // Load Queue Information (API #1: /ws/v1/partition/{partitionName}/queue/{queueName})
        async function loadQueueInfo() {
            const partitionName = document.getElementById('partitionNameInput').value.trim() || 'default';
            const queueName = document.getElementById('queueNameInput').value.trim();

            if (!queueName) {
                alert('Please enter a Queue Name (e.g., root.default)');
                return;
            }

            console.log(`Loading queue info: partition=${partitionName}, queue=${queueName}`);
            try {
                const response = await fetch(`${YUNIKORN_API}/partition/${partitionName}/queue/${encodeURIComponent(queueName)}`);
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const queueData = await response.json();
                console.log('Queue data:', queueData);

                displayQueueInfo(queueData, partitionName, queueName);
            } catch (error) {
                console.error('Failed to load queue info:', error);
                alert(`Failed to load queue info: ${error.message}`);
            }
        }

        // Display Queue Information
        function displayQueueInfo(queueData, partitionName, queueName) {
            const container = document.getElementById('queueInfoContainer');
            container.style.display = 'block';

            const grid = document.getElementById('queueInfoGrid');

            let html = '';
            html += createInfoItem('Partition Name', partitionName);
            html += createInfoItem('Queue Name', queueData.queueName || queueName);
            html += createInfoItem('Queue Path', queueData.queuePath || queueName);
            html += createInfoItem('State', queueData.state || 'Active');
            html += createInfoItem('Running Applications', queueData.runningApplications || 0);
            html += createInfoItem('Allocated Containers', queueData.allocatedContainers || 0);
            html += createInfoItem('Allocated Memory', formatGB(queueData.allocatedResource?.memory) + ' GB');
            html += createInfoItem('Allocated vCore', queueData.allocatedResource?.vcore || 0);
            html += createInfoItem('Pending Containers', queueData.pendingContainers || 0);
            html += createInfoItem('Pending Memory', formatGB(queueData.pendingResource?.memory) + ' GB');
            html += createInfoItem('Pending vCore', queueData.pendingResource?.vcore || 0);
            html += createInfoItem('Max Applications', queueData.maxApplications || 'Unlimited');
            html += createInfoItem('Max Resources', formatResourceCompact(queueData.maxResource));

            // Add properties if available
            if (queueData.properties && Object.keys(queueData.properties).length > 0) {
                html += '<div class="info-item" style="grid-column: 1 / -1;"><label>Properties:</label> <value>' +
                    Object.entries(queueData.properties).map(([k, v]) => `${k}=${v}`).join(', ') + '</value></div>';
            }

            // Add leaf queue specific info
            if (queueData.leafQueue) {
                html += createInfoItem('Leaf Queue', 'Yes');
            }

            grid.innerHTML = html;
        }

        // Load Queue Applications (API #2: /ws/v1/partition/{partitionName}/queue/{queueName}/applications)
        async function loadQueueApplications() {
            const partitionName = document.getElementById('partitionNameInput').value.trim() || 'default';
            const queueName = document.getElementById('queueNameInput').value.trim();

            if (!queueName) {
                alert('Please enter a Queue Name (e.g., root.default)');
                return;
            }

            console.log(`Loading queue applications: partition=${partitionName}, queue=${queueName}`);
            try {
                const response = await fetch(`${YUNIKORN_API}/partition/${partitionName}/queue/${encodeURIComponent(queueName)}/applications`);
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const apps = await response.json();
                console.log('Queue applications loaded:', apps);

                displayQueueApplications(apps);
            } catch (error) {
                console.error('Failed to load queue applications:', error);
                alert(`Failed to load queue applications: ${error.message}`);
            }
        }

        // Display Queue Applications
        function displayQueueApplications(apps) {
            const container = document.getElementById('queueAppsContainer');
            container.style.display = 'block';

            const tbody = document.getElementById('queueAppsBody');

            if (!apps || apps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280; padding: 20px;">No applications found in this queue</td></tr>';
                return;
            }

            let html = '';
            apps.forEach(app => {
                const stateClass = getStateClass(app.applicationState);
                const used = formatResourceCompact(app.usedResource);
                const pending = formatResourceCompact(app.pendingResource);
                const allocCount = app.allocations ? app.allocations.length : 0;
                const submissionTime = formatTimestamp(app.submissionTime);

                html += `
                    <tr>
                        <td><strong>${app.applicationID || 'N/A'}</strong></td>
                        <td>${app.queueName || 'N/A'}</td>
                        <td><span class="status-badge ${stateClass}">${app.applicationState || 'Unknown'}</span></td>
                        <td>${used}</td>
                        <td>${pending}</td>
                        <td>${allocCount}</td>
                        <td>${submissionTime}</td>
                        <td><button class="refresh-btn" onclick='searchAppById("${app.applicationID}")'>View</button></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Clear Queue Explorer
        function clearQueueExplorer() {
            document.getElementById('queueInfoContainer').style.display = 'none';
            document.getElementById('queueAppsContainer').style.display = 'none';
            document.getElementById('queueInfoGrid').innerHTML = '';
            document.getElementById('queueAppsBody').innerHTML = '';
        }

        // Display application details
        function displayAppDetails(app) {
            document.getElementById('appDashboard').style.display = 'block';
            document.getElementById('appsListCard').style.display = 'none';

            // Header info
            document.getElementById('appId').textContent = app.applicationID || 'N/A';
            document.getElementById('appQueue').textContent = app.queueName || 'N/A';
            document.getElementById('appSubmissionTime').textContent = formatTimestamp(app.submissionTime);

            const stateBadge = document.getElementById('appState');
            stateBadge.textContent = app.applicationState || 'Unknown';
            stateBadge.className = `status-badge ${getStateClass(app.applicationState)}`;

            // Placeholder status
            const placeholderStatus = document.getElementById('placeholderStatus');
            if (app.placeholderData && app.placeholderData.length > 0) {
                const totalPlaceholders = app.placeholderData.reduce((sum, p) => sum + (p.count || 0), 0);
                placeholderStatus.innerHTML = `<span class="info-pill">${totalPlaceholders} Placeholders</span>`;
            } else {
                placeholderStatus.innerHTML = '';
            }

            // Reservation status
            const reservationStatus = document.getElementById('reservationStatus');
            if (app.hasReserved) {
                reservationStatus.innerHTML = `<span class="info-pill">Reserved</span>`;
            } else {
                reservationStatus.innerHTML = '';
            }

            // Application info grid
            displayAppInfo(app);

            // Resources
            const used = app.usedResource || {};
            const pending = app.pendingResource || {};

            document.getElementById('usedMemory').textContent = formatGB(used.memory);
            document.getElementById('usedVcore').textContent = used.vcore || 0;
            document.getElementById('usedPods').textContent = used.pods || 0;

            document.getElementById('pendingMemory').textContent = formatGB(pending.memory);
            document.getElementById('pendingVcore').textContent = pending.vcore || 0;
            document.getElementById('pendingPods').textContent = pending.pods || 0;

            // Allocations summary
            const allocations = app.allocations || [];
            const requests = app.requests || [];

            document.getElementById('totalAllocations').textContent = allocations.length;
            document.getElementById('pendingRequestsCount').textContent = requests.length - allocations.length;

            const placeholderCount = allocations.filter(a => a.placeholder).length;
            document.getElementById('placeholderCount').textContent = placeholderCount;

            // Tables
            displayAllocations(allocations);
            displayPendingRequests(requests, allocations);
            displayAllocationLogs(requests);
            displayGangScheduling(app.placeholderData || [], allocations);
            displayPlaceholderDetails(app.placeholderData || [], allocations);
            displayAllocationTags(allocations);

            // Scroll to dashboard
            document.getElementById('appDashboard').scrollIntoView({ behavior: 'smooth' });
        }

        function displayAppInfo(app) {
            const grid = document.getElementById('appInfoGrid');
            const submissionTime = formatTimestamp(app.submissionTime);
            const startTime = formatTimestamp(app.startTime);
            const user = app.user || 'N/A';
            const partition = app.partition || 'N/A';

            let html = '';
            html += createInfoItem('User', user);
            html += createInfoItem('Partition', partition);
            html += createInfoItem('Queue', app.queueName || 'N/A');
            html += createInfoItem('Application ID', app.applicationID || 'N/A');
            html += createInfoItem('State', app.applicationState || 'N/A');
            html += createInfoItem('Submission Time', submissionTime);
            if (app.startTime > 0) {
                html += createInfoItem('Start Time', startTime);
            }
            if (app.finishedTime > 0) {
                html += createInfoItem('Finish Time', formatTimestamp(app.finishedTime));
            }
            html += createInfoItem('Has Reserved', app.hasReserved ? 'Yes' : 'No');

            grid.innerHTML = html;
        }

        function createInfoItem(label, value) {
            return `<div class="info-item"><label>${label}:</label> <value>${value}</value></div>`;
        }

        function backToList() {
            document.getElementById('appDashboard').style.display = 'none';
            document.getElementById('appsListCard').style.display = 'block';
            document.getElementById('appIdInput').value = '';
        }

        function displayAllocations(allocations) {
            const tbody = document.getElementById('allocationsBody');

            if (!allocations || allocations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #6b7280; padding: 20px;">No allocations yet</td></tr>';
                return;
            }

            let html = '';
            allocations.forEach(alloc => {
                const key = alloc.allocationKey?.substring(0, 16) + '...';
                const podName = alloc.allocationTags?.['kubernetes.io/meta/podName'] || alloc.nodeId || 'Unknown';
                const nodeName = alloc.nodeId || '-';
                const memory = formatGB(alloc.resource?.memory);
                const vcore = alloc.resource?.vcore || 0;
                const pods = alloc.resource?.pods || 0;
                const taskGroup = alloc.taskGroupName || '-';
                const placeholder = alloc.placeholder ? '<span class="placeholder-badge">Yes</span>' : '-';
                const requestTime = formatTimestamp(alloc.requestTime);
                const allocTime = alloc.allocationTime ? formatTimestamp(alloc.allocationTimeTime) : '-';
                const delay = alloc.allocationDelay ? (alloc.allocationDelay / 1000000).toFixed(2) + 'ms' : '-';

                html += `
                    <tr>
                        <td><code>${key}</code></td>
                        <td>${podName}</td>
                        <td>${nodeName}</td>
                        <td>${memory}</td>
                        <td>${vcore}</td>
                        <td>${pods}</td>
                        <td>${taskGroup}</td>
                        <td>${placeholder}</td>
                        <td>${requestTime}</td>
                        <td>${allocTime}</td>
                        <td>${delay}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function displayPendingRequests(requests, allocations) {
            const tbody = document.getElementById('pendingRequestsBody');

            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #6b7280; padding: 20px;">No pending requests</td></tr>';
                return;
            }

            // Filter out requests that have been allocated
            const allocatedKeys = new Set(allocations.map(a => a.allocationKey));
            const pending = requests.filter(r => !allocatedKeys.has(r.allocationKey));

            if (pending.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #6b7280; padding: 20px;">No pending requests</td></tr>';
                return;
            }

            let html = '';
            pending.forEach(req => {
                const key = req.allocationKey?.substring(0, 16) + '...';
                const podName = req.allocationTags?.['kubernetes.io/meta/podName'] || '-';
                const memory = formatGB(req.resource?.memory);
                const vcore = req.resource?.vcore || 0;
                const pods = req.resource?.pods || 0;
                const taskGroup = req.taskGroupName || '-';
                const priority = req.priority || '0';
                const scheduled = req.schedulingAttempted ? 'Yes' : 'No';
                const placeholder = req.placeholder ? '<span class="placeholder-badge">Yes</span>' : '-';
                const scaleUp = req.triggeredScaleUp ? 'Yes' : 'No';
                const logsCount = req.allocationLog ? req.allocationLog.length : 0;

                html += `
                    <tr>
                        <td><code>${key}</code></td>
                        <td>${podName}</td>
                        <td>${memory}</td>
                        <td>${vcore}</td>
                        <td>${pods}</td>
                        <td>${taskGroup}</td>
                        <td>${priority}</td>
                        <td>${scheduled}</td>
                        <td>${placeholder}</td>
                        <td>${scaleUp}</td>
                        <td>${logsCount}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function displayAllocationLogs(requests) {
            const tbody = document.getElementById('allocationLogsBody');
            const logs = [];

            requests.forEach(req => {
                if (req.allocationLog) {
                    req.allocationLog.forEach(log => {
                        logs.push({
                            key: req.allocationKey?.substring(0, 12) + '...',
                            message: log.message,
                            count: log.count,
                            time: log.lastOccurrence
                        });
                    });
                }
            });

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280; padding: 20px;">No scheduling events</td></tr>';
                return;
            }

            logs.sort((a, b) => b.count - a.count);
            const topLogs = logs.slice(0, 50);

            let html = '';
            topLogs.forEach(log => {
                const type = (log.message.toLowerCase().includes('fail') ||
                           log.message.toLowerCase().includes('taint') ||
                           log.message.toLowerCase().includes('affinity')) ? 'warning' : '';
                const time = formatTimestamp(log.time);

                html += `
                    <tr class="${type}">
                        <td><code>${log.key}</code></td>
                        <td>${log.message}</td>
                        <td>${log.count.toLocaleString()}</td>
                        <td style="font-size: 10px; color: #ffffff;">${time}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function displayGangScheduling(placeholderData, allocations) {
            const tbody = document.getElementById('gangSchedulingBody');

            if (!placeholderData || placeholderData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280; padding: 20px;">No gang scheduling data</td></tr>';
                return;
            }

            // Count actual allocations per task group
            const allocatedPerGroup = {};
            allocations.forEach(alloc => {
                const group = alloc.taskGroupName || 'unknown';
                allocatedPerGroup[group] = (allocatedPerGroup[group] || 0) + 1;
            });

            let html = '';
            placeholderData.forEach(data => {
                const group = data.taskGroupName;
                const allocated = allocatedPerGroup[group] || 0;
                const memory = formatGB(data.minResource?.memory);
                const vcore = data.minResource?.vcore || 0;
                const pods = data.minResource?.pods || 0;
                const required = data.count || 0;

                html += `
                    <tr>
                        <td><strong>${group}</strong></td>
                        <td>${memory}</td>
                        <td>${vcore}</td>
                        <td>${pods}</td>
                        <td>${allocated} / ${required}</td>
                        <td>${data.replaced || 0}</td>
                        <td>${data.timedout || 0}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function displayPlaceholderDetails(placeholderData, allocations) {
            const tbody = document.getElementById('placeholderDetailsBody');

            if (!placeholderData || placeholderData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280; padding: 20px;">No placeholder data</td></tr>';
                return;
            }

            // Count actual allocations per task group
            const allocatedPerGroup = {};
            allocations.forEach(alloc => {
                const group = alloc.taskGroupName || 'unknown';
                allocatedPerGroup[group] = (allocatedPerGroup[group] || 0) + 1;
            });

            let html = '';
            placeholderData.forEach(data => {
                const group = data.taskGroupName;
                const allocated = allocatedPerGroup[group] || 0;
                const memory = formatGB(data.minResource?.memory);
                const vcore = data.minResource?.vcore || 0;
                const pods = data.minResource?.pods || 0;
                const required = data.count || 0;
                const progress = required > 0 ? Math.min((allocated / required) * 100, 100) : 0;
                const progressColor = progress === 100 ? '#ffffff' : progress > 0 ? '#ffffff' : '#ffffff';

                html += `
                    <tr>
                        <td><strong>${group}</strong></td>
                        <td>${memory}</td>
                        <td>${vcore}</td>
                        <td>${pods}</td>
                        <td>${allocated} / ${required}</td>
                        <td>${data.replaced || 0}</td>
                        <td>${data.timedout || 0}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function displayAllocationTags(allocations) {
            const tbody = document.getElementById('allocationTagsBody');

            if (!allocations || allocations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280; padding: 20px;">No allocation tags</td></tr>';
                return;
            }

            let html = '';
            allocations.forEach(alloc => {
                const key = alloc.allocationKey?.substring(0, 12) + '...';
                const podName = alloc.allocationTags?.['kubernetes.io/meta/podName'] || '-';
                const namespace = alloc.allocationTags?.['kubernetes.io/meta/namespace'] || '-';
                const appId = alloc.allocationTags?.['kubernetes.io/label/applicationId'] || '-';
                const queue = alloc.allocationTags?.['kubernetes.io/label/yunikorn.apache.org/queue'] || '-';
                const labels = alloc.allocationTags ? Object.entries(alloc.allocationTags)
                    .filter(([k]) => !k.startsWith('kubernetes.io/'))
                    .map(([k, v]) => `<span style="background:#ffffff; padding:2px 6px; border-radius:3px; margin:2px; font-size:10px; display:inline-block;">${k}: ${v}</span>`)
                    .join(' ') : '-';

                html += `
                    <tr>
                        <td><code>${key}</code></td>
                        <td>${podName}</td>
                        <td>${namespace}</td>
                        <td><code>${appId}</code></td>
                        <td>${queue}</td>
                        <td>${labels}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // Helper functions
        function formatGB(value) {
            if (!value) return '0';
            return parseFloat(value).toFixed(1);
        }

        function formatResourceCompact(resource) {
            if (!resource) return '-';
            const parts = [];
            if (resource.memory) parts.push(`${formatGB(resource.memory)}GB`);
            if (resource.vcore) parts.push(`${resource.vcore} cores`);
            if (resource.pods) parts.push(`${resource.pods} pods`);
            return parts.join(', ') || '-';
        }

        function formatTimestamp(nanos) {
            if (!nanos || nanos <= 0) return 'N/A';
            const ms = nanos / 1000000;
            const date = new Date(ms);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' hours ago';
            return date.toLocaleTimeString();
        }

        function getStateClass(state) {
            const stateMap = {
                'Running': 'status-running',
                'Accepted': 'status-accepted',
                'New': 'status-pending',
                'Pending': 'status-pending',
                'Completed': 'status-completed',
                'Failed': 'status-failed',
                'Rejected': 'status-failed'
            };
            return stateMap[state] || 'status-pending';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing Yunikorn UI...');
            loadApps();

            setInterval(() => {
                if (document.getElementById('appDashboard').style.display === 'none') {
                    loadApps();
                }
            }, 30000);
        });

        document.getElementById('appIdInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchApp();
            }
        });
    </script>
</body>
</html>
